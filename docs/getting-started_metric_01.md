# 性能指标数据收集(metric)

hydra 提供了 QPS、正在处理数、响应时间、响应状态码的统计数据，这些数据包括机器 IP，服务器，请求地址的瞬时数据，m1,m5,m15 统计值，平均值等。这些数据保存到 influxdb 中。可通过 grafana 配置为动态图表进行实时监控，或使用`convoy`配置报警，通过短信、微信发送到指定的用户组。

#### 1. metric 配置

- 所有服务器都支持（api,rpc,web,mqc,cron,ws）

- 设置服务的子节点配置，配置名为`metric`。即可打开数据收集功能。

`metric`配置实际是`influxdb`服务器连接配置:

|  参数名  | 必须 | 说明                       |
| :------: | :--: | -------------------------- |
|   host   |  是  | influxdb 服务器地址        |
| dataBase |  是  | 数据库名称                 |
|   cron   |  是  | 保存到 influxdb 的间隔时长 |
| userName |  否  | 用户名                     |
| password |  否  | 密码                       |

```go



package main

import (
	"github.com/micro-plat/hydra/context"

	"github.com/micro-plat/hydra/hydra"
)

type apiserver struct {
	*hydra.MicroApp
}

func main() {
	app := &apiserver{
		hydra.NewApp(
			hydra.WithPlatName("mall"),
			hydra.WithSystemName("apiserver"),
			hydra.WithServerTypes("api")),
	}

	app.API("/hello", hello)
	app.Conf.API.SetSubConf("metric", `{
		"host":"http://192.168.106.219:8086",
	"dataBase":"mall_apiserver",
	"cron":"@every 10s",
	"userName":"",
	"password":""
    }	`)

	app.Start()

}

func hello(ctx *context.Context) (r interface{}) {
	return "hello world"
}

```

#### 2.查看 influxdb 中的配置信息

##### 请求服务

运行后通过`ab`发送清求

```sh
ab -c 1 -n 100000 http://localhost:8090/hello

```

##### 查看 influxdb 中表和数据

- 登录 influxdb http://host:8083,切换到当前使用的数据库

* 执行命令`SHOW MEASUREMENTS`，查看所有表信息：

  ###### measurements

  | name                       | 说明       |
  | -------------------------- | ---------- |
  | api.server.request.qps     | qps 数据   |
  | api.server.request.timer   | 时长数据   |
  | api.server.request.working | 处理中数据 |
  | api.server.response.meter  | 响应数据   |

* 查询表数据

  - 执行命令 `select * from "api.server.request.qps"`

可查看最近 1 分钟，5 分钟，15 分钟内的请求数

###### api.server.request.qps

| time                           | host            | m1    | m15   | m5    | name                | url      |
| :----------------------------- | --------------- | ----- | ----- | ----- | ------------------- | -------- |
| 2019-07-03T01:27:34.571054403Z | "192.168.4.121" | 360   | 360   | 360   | "mall.apiserver.yl" | "/hello" |
| 2019-07-03T01:27:44.570693377Z | "192.168.4.121" | 28044 | 28044 | 28044 | "mall.apiserver.yl" | "/hello" |
| 2019-07-03T01:27:54.570326513Z | "192.168.4.121" | 54963 | 54963 | 54963 | "mall.apiserver.yl" | "/hello" |

> 数据为每隔 10 秒保存 1 次，`name`是`平台名称`，`系统名称`，`集名名称`的组合

- 执行命令 `select * from "api.server.request.timer"`

###### api.server.request.timer

可查看每个请求最近 1 分钟，5 分钟，15 分钟的请求时长，以前请求时间的最大值，最小值，50%，75%，95%，99%，99.9%的请求的完成时长

| time                           | count | host            | m1                 | m15                | m5                 | max    | mean               | meanrate          | min   | name                | p50    | p75    | p95                | p99                | p999              | p9999  | stddev             | url      | variance           |
| :----------------------------- | ----- | --------------- | ------------------ | ------------------ | ------------------ | ------ | ------------------ | ----------------- | ----- | ------------------- | ------ | ------ | ------------------ | ------------------ | ----------------- | ------ | ------------------ | -------- | ------------------ |
| 2019-07-03T01:27:34.571061828Z | 360   | "192.168.4.121" | 0                  | 0                  | 0                  | 390112 | 118943.21388888889 | 3057.245339403573 | 77002 | "mall.apiserver.yl" | 104966 | 113584 | 243054.5499999999  | 329669.33999999985 | 390112            | 390112 | 46602.85919329803  | "/hello" | 2171826484.9903626 |
| 2019-07-03T01:27:44.570700223Z | 28044 | "192.168.4.121" | 385.03330790386286 | 27.699062827315974 | 82.1883343275836   | 840981 | 118393.66828793775 | 2771.920956428636 | 81534 | "mall.apiserver.yl" | 104220 | 117991 | 192104.8           | 409889.2800000003  | 836100.9090000007 | 840981 | 56150.085619625985 | "/hello" | 3152832115.0913286 |
| 2019-07-03T01:27:54.570333895Z | 54962 | "192.168.4.121" | 739.9682623368426  | 57.20104574471909  | 167.93066219699298 | 804686 | 113945.68190661479 | 2732.135471536243 | 84264 | "mall.apiserver.yl" | 105345 | 118360 | 148096.44999999998 | 291116.0400000007  | 804547.612        | 804686 | 46111.41297201026  | "/hello" | 2126262406.2752757 |

- 执行命令 `select * from "api.server.request.working"`

###### api.server.request.working

可看到每个请求在上报时间点内正在处理的线程数

| time                           | host            | name                | url      | value |
| :----------------------------- | --------------- | ------------------- | -------- | ----- |
| 2019-07-03T01:27:34.571057319Z | "192.168.4.121" | "mall.apiserver.yl" | "/hello" | 0     |
| 2019-07-03T01:27:44.570697624Z | "192.168.4.121" | "mall.apiserver.yl" | "/hello" | 0     |
| 2019-07-03T01:27:54.570331476Z | "192.168.4.121" | "mall.apiserver.yl" | "/hello" | 0     |
| 2019-07-03T01:28:04.570261436Z | "192.168.4.121" | "mall.apiserver.yl" | "/hello" | 1     |
| 2019-07-03T01:28:14.570386432Z | "192.168.4.121" | "mall.apiserver.yl" | "/hello" | 0     |
| 2019-07-03T01:28:24.570468063Z | "192.168.4.121" | "mall.apiserver.yl" | "/hello" | 0     |
| 2019-07-03T01:28:34.5708024Z   | "192.168.4.121" | "mall.apiserver.yl" | "/hello" | 0     |
| 2019-07-03T01:28:44.571053764Z | "192.168.4.121" | "mall.apiserver.yl" | "/hello" | 0     |
| 2019-07-03T01:28:54.570372963Z | "192.168.4.121" | "mall.apiserver.yl" | "/hello" | 0     |

- 执行命令 `select * from "api.server.response.meter"`

###### api.server.response.meter

每个请求的不同状态码在统计时间内出现的次数

| time                           | count  | host            | m1                 | m15                | m5                 | mean               | name                | status | url      |
| :----------------------------- | ------ | --------------- | ------------------ | ------------------ | ------------------ | ------------------ | ------------------- | ------ | -------- |
| 2019-07-03T01:27:34.571046412Z | 359    | "192.168.4.121" | 0                  | 0                  | 0                  | 3064.3368533487424 | "mall.apiserver.yl" | "200"  | "/hello" |
| 2019-07-03T01:27:44.570900407Z | 28045  | "192.168.4.121" | 2479.2290952832423 | 2474.36232594048   | 2475.080966920066  | 2771.959550488491  | "mall.apiserver.yl" | "200"  | "/hello" |
| 2019-07-03T01:27:54.570519887Z | 54963  | "192.168.4.121" | 2512.6667246963975 | 2476.8296322716205 | 2482.3749431652154 | 2732.1651076650282 | "mall.apiserver.yl" | "200"  | "/hello" |
| 2019-07-03T01:28:04.57114069Z  | 81256  | "192.168.4.121" | 2533.481301839644  | 2478.7314953310274 | 2487.832644814569  | 2697.973616763035  | "mall.apiserver.yl" | "200"  | "/hello" |
| 2019-07-03T01:28:14.570873075Z | 100000 | "192.168.4.121" | 2471.434900021882  | 2475.0488338914784 | 2476.532333046619  | 2560.7683321764957 | "mall.apiserver.yl" | "200"  | "/hello" |

#### 3. 通过 grafana 配置监控图表
